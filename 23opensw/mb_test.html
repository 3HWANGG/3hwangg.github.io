<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>범람지도지도</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.20.1/ol.css" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.20.1/ol.js"></script>
</head>
<body>
<div id="map" style="width: 100%; height: 700px;"></div>
<script>
var param = {
    name: '하천범람지도(지방하천)',
    serverUrl: 'https://www.safemap.go.kr/openApiService/wms/getLayerData.do?apikey=EALWNP4P-EALW-EALW-EALW-EALWNP4PP7',
    layername: 'A2SM_FLOODFOVRRISK2',
    styles: ''
};

var wmsLayer = new ol.layer.Image({
    source: new ol.source.ImageWMS({
        url: param.serverUrl,
        params: {
            'LAYERS': param.layername,
            'FORMAT': 'image/png',
            'TRANSPARENT': true
        },
        ratio: 1,
        serverType: 'geoserver'
    }),
    visible: true
});

var map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        }),
        wmsLayer
    ],
    view: new ol.View({
        center: ol.proj.fromLonLat([126.9784, 37.5665]),
        zoom: 12
    })
});

var container = document.getElementById('popup');
var content = document.getElementById('popup-content');
var closer = document.getElementById('popup-closer');

var overlay = new ol.Overlay({
    element: container,
    autoPan: true,
    autoPanAnimation: {
        duration: 250
    }
});
overlay.setPosition(undefined);
closer.blur();

// 위치 권한 요청 및 처리
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        // 지도의 중심을 현재 위치로 이동하고 레이어 추가
        map.getView().setCenter(ol.proj.fromLonLat([lon, lat]));
        map.getView().setZoom(16);

        var layer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat]))
                    })
                ]
            })
        });
        map.addLayer(layer);

        content.innerHTML = '<b>현재 위치입니다!</b>';
        overlay.setPosition(ol.proj.fromLonLat([lon, lat]));
        map.addOverlay(overlay);
    });
} else {
    // 위치 기능을 지원하지 않는 경우 기본 위치로 설정
    var defaultPosition = ol.proj.fromLonLat([126.9784, 37.5665]);
    map.getView().setCenter(defaultPosition);
    map.getView().setZoom(12);

    var layer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [
                new ol.Feature({
                    geometry: new ol.geom.Point(defaultPosition)
                })
            ]
        })
    });
    map.addLayer(layer);

    content.innerHTML = '<b>현재 위치를 찾을 수 없습니다.</b>';
    overlay.setPosition(defaultPosition);
    map.addOverlay(overlay);
}
</script>
</body>
</html>
